use num_traits::int::PrimInt;
use num_traits::cast::NumCast;
pub fn isqrt<T>(x: T) -> T
where
    T: PrimInt,
{
    <T as NumCast>::from((<f64 as NumCast>::from(x).unwrap() + 0.5).sqrt()).unwrap()
}

pub fn ctab(i: usize) -> i32 {
    let _ctab = [
        0, 1, 256, 257, 2, 3, 258, 259, 512, 513, 768, 769, 514, 515, 770, 771, 4, 5, 260, 261, 6,
        7, 262, 263, 516, 517, 772, 773, 518, 519, 774, 775, 1024, 1025, 1280, 1281, 1026, 1027,
        1282, 1283, 1536, 1537, 1792, 1793, 1538, 1539, 1794, 1795, 1028, 1029, 1284, 1285, 1030,
        1031, 1286, 1287, 1540, 1541, 1796, 1797, 1542, 1543, 1798, 1799, 8, 9, 264, 265, 10, 11,
        266, 267, 520, 521, 776, 777, 522, 523, 778, 779, 12, 13, 268, 269, 14, 15, 270, 271, 524,
        525, 780, 781, 526, 527, 782, 783, 1032, 1033, 1288, 1289, 1034, 1035, 1290, 1291, 1544,
        1545, 1800, 1801, 1546, 1547, 1802, 1803, 1036, 1037, 1292, 1293, 1038, 1039, 1294, 1295,
        1548, 1549, 1804, 1805, 1550, 1551, 1806, 1807, 2048, 2049, 2304, 2305, 2050, 2051, 2306,
        2307, 2560, 2561, 2816, 2817, 2562, 2563, 2818, 2819, 2052, 2053, 2308, 2309, 2054, 2055,
        2310, 2311, 2564, 2565, 2820, 2821, 2566, 2567, 2822, 2823, 3072, 3073, 3328, 3329, 3074,
        3075, 3330, 3331, 3584, 3585, 3840, 3841, 3586, 3587, 3842, 3843, 3076, 3077, 3332, 3333,
        3078, 3079, 3334, 3335, 3588, 3589, 3844, 3845, 3590, 3591, 3846, 3847, 2056, 2057, 2312,
        2313, 2058, 2059, 2314, 2315, 2568, 2569, 2824, 2825, 2570, 2571, 2826, 2827, 2060, 2061,
        2316, 2317, 2062, 2063, 2318, 2319, 2572, 2573, 2828, 2829, 2574, 2575, 2830, 2831, 3080,
        3081, 3336, 3337, 3082, 3083, 3338, 3339, 3592, 3593, 3848, 3849, 3594, 3595, 3850, 3851,
        3084, 3085, 3340, 3341, 3086, 3087, 3342, 3343, 3596, 3597, 3852, 3853, 3598, 3599, 3854,
        3855,
    ];
    _ctab[i]
}

fn nest2xyf(nside: i32, mut pix: i32) -> (i32, i32, i32) {
    let npface = nside * nside;
    let face_num = pix / npface;
    pix &= npface - 1;
    let mut raw = (pix & 0x5555) | ((pix & 0x55550000) >> 15);
    let ix = ctab((raw & 0xff) as usize) | (ctab((raw >> 8) as usize) << 4);
    pix >>= 1;
    raw = (pix & 0x5555) | ((pix & 0x55550000) >> 15);
    let iy = ctab((raw & 0xff) as usize) | (ctab((raw >> 8) as usize) << 4);
    (ix, iy, face_num)
}
